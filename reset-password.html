<!DOCTYPE html>
<html lang="pt-br">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6241000006441036"
     crossorigin="anonymous"></script>


  <meta charset="UTF-8" />
  <title>Redefinir Senha | Mooose</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Redefina sua senha da Mooose, plataforma de correção de redação do ENEM com IA.">
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap"
    rel="stylesheet"
  />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HRHF1XJTSD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HRHF1XJTSD');
  </script>

  <style>
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #dbeafe, #eff6ff 40%, #e2e8f0 100%);
      margin: 0;
      padding: 1rem;
    }
    main {
      background: white;
      border-radius: 24px;
      padding: 2.5rem 2rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.18);
      text-align: center;
      border: 2px solid #e2e8f0;
    }
    .logo-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 1.5rem;
    }
    .logo-row {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .mooose-logo {
      width: 48px;
      height: 48px;
    }
    .logo-word {
      font-weight: 900;
      letter-spacing: 0.18em;
      font-size: 1.1rem;
      color: #1d4ed8;
    }
    .logo-subtitle {
      font-size: 0.75rem;
      color: #64748b;
    }
    .badge-edu {
      padding: 0.1rem 0.5rem;
      border-radius: 99px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      font-size: 0.7rem;
      color: #64748b;
      margin-left: 0.5rem;
      vertical-align: middle;
    }
    .auth-card {
      display: block;
      text-align: left;
      margin-top: 1rem;
    }
    .auth-card.hidden {
      display: none;
    }
    h2 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: #1f2933;
      text-align: left;
    }
    p {
      font-size: 0.95rem;
      color: #64748b;
      margin-bottom: 1rem;
    }
    form {
      margin-top: 1rem;
    }
    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 700;
      color: #64748b;
      margin-bottom: 0.3rem;
    }
    .form-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 14px;
      background: #f8fafc;
      font-size: 1rem;
      transition: all 0.2s;
      margin-bottom: 1rem;
    }
    .form-input:focus {
      outline: none;
      border-color: #2563eb;
      background: #ffffff;
    }
    .form-message {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      text-align: center;
    }
    .form-message.error {
      color: #dc2626;
    }
    .form-message.success {
      color: #16a34a;
    }
  </style>
</head>
<body>
  <main>
    <div class="logo-area" style="align-items: center; margin-bottom: 1.5rem;">
      <div class="logo-row">
        <img src="logo.png" alt="Mooose" class="mooose-logo" />
        <span class="logo-word">
          <span class="logo-m">M</span>
          <span class="logo-o logo-o-1">O</span>
          <span class="logo-o logo-o-2">O</span>
          <span class="logo-o logo-o-3">O</span>
          <span class="logo-rest">SE</span>
        </span>
      </div>
      <span class="logo-subtitle">
        Correção de redações do ENEM com IA <span class="badge-edu">2 créditos grátis</span>
      </span>
    </div>

    <div class="auth-card" id="reset-card">
        <h2>Redefinir senha</h2>
        <p>Escolha uma nova senha para continuar utilizando a Mooose.</p>
        <form id="form-reset-password">
            <div class="form-message" id="reset-message"></div>

            <label class="form-label">
              Nova senha
              <input class="form-input" type="password" name="new_password" required minlength="4" />
            </label>
            <label class="form-label">
              Confirme a nova senha
              <input class="form-input" type="password" name="confirm_password" required minlength="4" />
            </label>
            <button type="submit" class="primary-btn full">
              Salvar nova senha
            </button>
        </form>
    </div>

    <div class="auth-card hidden" id="success-card">
        <h2>Sucesso!</h2>
        <p id="success-message" class="form-message success" style="font-size: 1rem;">
            Sua senha foi atualizada.
        </p>
        <a href="index.html" class="primary-btn" style="margin-top: 1rem;">Ir para o Login</a>
    </div>

  </main>

  <script src="app.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const msgEl = document.getElementById("reset-message");
      const form = document.getElementById("form-reset-password");
      const resetCard = document.getElementById("reset-card");
      const successCard = document.getElementById("success-card");
      const successMsg = document.getElementById("success-message");

      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");

      if (!token) {
        msgEl.textContent = "Erro: Token de redefinição não encontrado na URL.";
        msgEl.classList.add("error");
        return;
      }

      if (typeof API_BASE === "undefined") {
        msgEl.textContent = "Erro: Falha ao carregar configuração da API.";
        msgEl.classList.add("error");
        return;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msgEl.textContent = "";
        msgEl.classList.remove("error", "success");

        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.disabled = true;

        const formData = new FormData(form);
        const newPassword = formData.get("new_password");
        const confirmPassword = formData.get("confirm_password");

        if (!newPassword || !confirmPassword) {
          msgEl.textContent = "Preencha todos os campos.";
          msgEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        if (newPassword !== confirmPassword) {
          msgEl.textContent = "As senhas não coincidem.";
          msgEl.classList.add("error");
          submitBtn.disabled = false;
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/auth/reset-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              token: token,           // <-- Token agora vai no body
              new_password: newPassword,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            // Tenta extrair uma mensagem decente do detail
            let msg = "Falha ao redefinir a senha. O token pode ter expirado.";
            if (data.detail) {
              if (typeof data.detail === "string") {
                msg = data.detail;
              } else if (Array.isArray(data.detail) && data.detail[0]?.msg) {
                msg = data.detail[0].msg;
              }
            }
            throw new Error(msg);
          }

          // Sucesso!
          successMsg.textContent = data.message || "Senha atualizada com sucesso!";
          resetCard.classList.add("hidden");
          successCard.classList.remove("hidden");
        } catch (err) {
          console.error(err);
          msgEl.textContent = `Erro: ${err.message || err}`;
          msgEl.classList.add("error");
        } finally {
          submitBtn.disabled = false;
        }
      });
    });
  </script>

</body>
</html>
